import streamlit as st
import pandas as pd
import numpy as np
import pickle
import plotly.graph_objects as go

# --- PAGE CONFIGURATION ---
st.set_page_config(
    page_title="Breast Cancer Diagnostic Pro",
    page_icon="ü©∫",
    layout="wide"
)


# --- LOAD ASSETS ---
@st.cache_resource
def load_model_assets():
    try:
        # Load the 3 files generated by your Jupyter Notebook
        model = pickle.load(open('cancer_model.pkl', 'rb'))
        scaler = pickle.load(open('scaler.pkl', 'rb'))
        feature_names = pickle.load(open('features.pkl', 'rb'))
        return model, scaler, feature_names
    except FileNotFoundError:
        # If files aren't found, we return None to trigger an error message in the UI
        return None, None, None


model, scaler, feature_names = load_model_assets()

# --- SIDEBAR INPUTS ---
st.sidebar.image("https://cdn-icons-png.flaticon.com/512/2864/2864339.png", width=100)
st.sidebar.title("Clinical Inputs")
st.sidebar.write("Adjust the sliders based on the pathology report:")


def get_user_inputs():
    if feature_names is None:
        return None, None

    # These are the 5 most impactful features for the user to control
    input_values = {}
    input_values['radius_mean'] = st.sidebar.slider("Radius Mean", 6.0, 30.0, 14.1)
    input_values['texture_mean'] = st.sidebar.slider("Texture Mean", 9.0, 40.0, 19.2)
    input_values['perimeter_mean'] = st.sidebar.slider("Perimeter Mean", 43.0, 190.0, 91.9)
    input_values['area_mean'] = st.sidebar.slider("Area Mean", 143.0, 2500.0, 654.0)
    input_values['concave points_mean'] = st.sidebar.slider("Concave Points Mean", 0.0, 0.2, 0.05)

    # Building the 30-feature array for the model
    # Features not in our sliders are filled with neutral median values (0.1)
    full_feature_array = []
    for name in feature_names:
        if name in input_values:
            full_feature_array.append(input_values[name])
        else:
            full_feature_array.append(0.1)

    return np.array(full_feature_array).reshape(1, -1), input_values


# --- MAIN INTERFACE ---
st.title("ü©∫ Breast Cancer Diagnostic Assistant")

if model is None:
    st.error("### ‚ö†Ô∏è Model Files Missing!")
    st.info("Please ensure 'cancer_model.pkl', 'scaler.pkl', and 'features.pkl' are in the same folder as this script.")
else:
    user_input_array, display_dict = get_user_inputs()

    col1, col2 = st.columns([1.5, 1])

    with col1:
        st.subheader("Tumor Characteristic Visualization")
        # Interactive Radar Chart
        categories = ['Radius', 'Texture', 'Perimeter', 'Area', 'Concavity']
        fig = go.Figure()

        fig.add_trace(go.Scatterpolar(
            r=[display_dict['radius_mean'], display_dict['texture_mean'] / 2,
               display_dict['perimeter_mean'] / 10, display_dict['area_mean'] / 100,
               display_dict['concave points_mean'] * 100],
            theta=categories,
            fill='toself',
            name='Patient Data',
            line_color='#FF4B4B'
        ))

        fig.update_layout(
            polar=dict(radialaxis=dict(visible=True, range=[0, 30])),
            showlegend=False,
            height=450
        )
        st.plotly_chart(fig, use_container_width=True)

    with col2:
        st.subheader("AI Prediction Result")
        st.write("Click below to process clinical data through the Logistic Regression model.")

        if st.button("Run Diagnostic Analysis"):
            # Scaling and Prediction
            scaled_input = scaler.transform(user_input_array)
            prediction = model.predict(scaled_input)
            probability = model.predict_proba(scaled_input)

            st.markdown("---")

            if prediction[0] == 1:
                st.error("## Result: MALIGNANT")
                st.write(f"**Confidence Level:** `{probability[0][1] * 100:.2f}%`")
                st.write("The model detects characteristics strongly associated with cancerous cells.")
            else:
                st.success("## Result: BENIGN")
                st.write(f"**Confidence Level:** `{probability[0][0] * 100:.2f}%`")
                st.write("The model suggests the sample is non-cancerous.")

    st.divider()
    st.markdown("""
    **Project Info:** - **Dataset:** Wisconsin Diagnostic Breast Cancer (WDBC)  
    - **Accuracy:** ~98%  
    - **Internship Project:** Skillfied Mentor
    """)